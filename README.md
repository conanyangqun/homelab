# homelab

Homelab，指在家中搭建的实验环境，通常指一系列硬件设备（家用服务器、小主机、树莓派等），运行着操作系统和软件。Homelab有多种用途，例如作为软路由、远程主机、部署自托管服务等，包括但不限于个人书库、影视库、密码管理、个人网站、RSS阅读器等。

**神骏的Homelab，是神骏于山东家中搭建的一系列硬件设备**。这个仓库用来存储相应的文档、搭建教程等。因为部署在山东，又被我戏称为：山东机房。

## 神骏的homelab配置

目前，homelab的配置如下，含路由器等设备。

名称|描述
---|---
光猫|山东联通送的（你懂的）
华硕RT-AX56U V2|华硕入门级路由器
群晖DS220+|NAS存储，数据集中存储位置
APC BK650-CN2|APC后备式UPS电源，作为NAS断电的应急处理
s01|2015年DIY的台式机，安装ubuntu 22.04作为服务器用，主机名s01
监控摄像头|海康威视x3、乔安x2
优酷路由器|远程调试备用终端
米家温湿度计2+米家wifi插座蓝牙网关版|温湿度监控

## 各个部分介绍

### 网络

山东联通1000M宽带，已开通桥接，实现光猫只负责光电转换，路由器负责拨号、客户端管理。另外，关键的一点，山东联通提供动态公网IP。

### 路由器

华硕RT-AX56U V2。华硕入门级路由器。开通以下服务：
- 桥接。获取动态公网IP。
- DDNS。使用华硕官方的服务，将动态IP映射为固定的域名。
- OpenVPN服务。用于远程接入山东的局域网，访问NAS、s01等。

### NAS

群晖DS220+ NAS存储，配一块16T希捷银河盘作为主力存储，一块4T希捷酷鹰作为备份盘。（不用raid，冗余备份要比raid重建靠谱）。开通的服务如下：
- 常规的文件服务。包括但不限于SMB、NFS等。
- quickconnect。群晖官方的内网穿透服务，见下文远程访问部分。
- DDNS服务。群晖提供的DDNS服务，将动态IP映射为固定域名，服务质量优于华硕的服务。
- 反向代理服务。将局域网的http服务通过反向代理转换为https服务，暴露到公网中。
- UPS服务。UPS设备直接连接群晖NAS，群晖提供UPS网络服务，供网络内其他客户端访问UPS。

### APC BK650-CN2

APC后备式UPS电源，直接连接群晖，提供突然断电的保障措施。

### s01

2015年左右DIY的一台普通家用电脑，配置如下：
- CPU: i3-4160。
- 内存: 16G DDR3（满配）。
- 硬盘：4T 酷鱼叠瓦盘。
- OS：ubuntu 22.04 LTS Desktop。

此机器部署了一些常用的自托管服务（见下），24 x 7开机，提供日常服务。2024-10-01（国庆期间）正式转正，接替群晖成为主力机。

### 监控摄像头

海康威视监控头3个、乔安室内监控头2个。（自从某年捡到一枚断线的海康威视监控头，将线接好正常工作后，算是无心插柳，断断续续的搞了几个监控头）。

### 优酷路由器

路由器品牌横行时白嫖的一款路由器，刷了openwrt系统。但是由于性能羸弱，目前作为远程调控的备用跳板机。

## 远程访问

homelab安装在山东的家中，但是作为一枚常年在外打工人，远程访问、断复电自动启动是必备的设置。这里介绍远程访问。

在有电、有网的前提下，远程访问有以下三种方案：
- 山东联通动态公网IP + OpenVPN。
- zerotier虚拟局域网。
- 群晖quickconnect。

### 动态公网IP

公网IP。这种方案的前提是要有公网IP，即便是动态的公网IP也可以。山东联通目前还提供动态公网IP（至少我村是）。光猫改桥接，路由器拨号后，动态IP直接分配到路由器的wan口，可以远程访问。

DDNS。动态公网IP的IP是变动的，通过DDNS可以自动将变动的IP映射为固定的域名。我同时开启了华硕和群晖的DDNS服务。

OpenVPN服务。在有了公网IP的前提下，可以开启路由器上的OpenVPN服务，手机等设备安装OpenVPN客户端后即可远程连入山东的局域网，访问局域网内的服务。

### zerotier

zerotier是一个虚拟局域网服务。在其官网申请了网络ID后，可以将加入同一个网络ID的设备连入同一个局域网下。但是其连接质量取决于网络，核心还是p2p打洞。打洞成功客户端直连，失败则通过国外的服务器中转，速度奇慢。

我的使用环境（北京联通 to 山东联通、北京电信 to 山东联通）在大部分情况下都可以成功打洞，ping延迟在30ms左右。

当然，刚刚切换网络，例如手机wifi切换成5G，需要一段时间来打洞。另外，蜂窝网络打洞成功的概率较小。

### 群晖quickconnect

当初黑群转白裙是冲着这个quickconnect去的，但是发现速度限制在1MB/s，而且只能访问部分app。虽然我也研究过如何暴露其他服务，但是这个方案目前只作为最后的备份方案，在极其罕见的情况下作为救急使用。

### 综上

总体来说，公网IP的方案和zerotier的方案性能都不错。但是zerotier的方案在蜂窝网络下表现一般，所以我现在已经逐渐切换成公网IP的方案。

## 断电停机和复电开机

光猫、路由、监控头等设备，断电关机，复电自动开机，不需要额外设置。

群晖NAS。断电后，通过UPS暂时供电。通知网络内其他客户端（UPS网络服务）断电，等待3分钟后进入待机模式，后关闭UPS。复电后，UPS自动开机，群晖NAS自动开机并开启服务。

s01。断电后，通过网络获知UPS状态，等待60s，市电未恢复，进入关机进程。复电后，自动开机。

**如此，实现断电关机、复电开机的自动化任务**。

## 功耗和电费

具体的功耗我没有计算过，但是现在几乎全部设备开启的情况下，每天电量在1.71度。

## 自托管服务

以下自托管服务之前部署在群晖DS220+上，但是由于那颗羸弱的CPU，导致开启个服务load就飙升至10，索性在2024年国庆将这些服务都迁移到了s01上。具体服务如下：

等待补充。

## 后续计划

千兆交换机。路由器只有4个网口，现在不够用了。考虑升级16口千兆交换机。

服务器。后续不排除继续增加服务器的可能性。台式工作站还是小主机，看后续。

监控头。可能考虑大华的360度监控头，凑一个万国牌监控（海康的太贵了）。

